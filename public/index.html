<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onpoint-Galleries</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FFA500',
                        dark: '#141414',
                        darker: '#222222',
                    }
                }
            }
        }
    </script>
    <style>
        .dropzone {
            border: 2px dashed rgba(255, 165, 0, 0.3);
            transition: all 0.3s ease;
        }
        .dropzone.active {
            border-color: #FFA500;
            background-color: rgba(255, 165, 0, 0.05);
        }
        .folder:hover {
            transform: translateY(-5px);
        }
        .photo:hover {
            transform: scale(1.03);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #000000;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #FFA500;
            border-radius: 3px;
        }
        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background-color: #222222;
            color: #e5e7eb;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast.success .toast-icon { color: #22c55e; }
        .toast.error .toast-icon { color: #ef4444; }
    </style>
</head>
<body class="bg-dark text-gray-200 min-h-screen">
    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-darker py-4 px-6 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-camera text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold text-primary">Onpoint Galleries</h1>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <div class="max-w-7xl mx-auto">
                <!-- Dashboard Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-primary mb-2">Admin Dashboard</h2>
                        <p class="text-gray-400">Manage client galleries and upload photos</p>
                    </div>
                    <button id="new-client-btn" class="bg-primary hover:bg-opacity-90 text-dark font-medium py-2 px-4 rounded-lg transition mt-4 md:mt-0">
                        <i class="fas fa-plus mr-2"></i> New Client
                    </button>
                </div>

                <!-- Client Folders Section -->
                <section class="mb-12">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-primary">Client Folders</h3>
                        <div class="relative">
                            <input id="client-search-input" type="text" placeholder="Search clients..." class="bg-darker border border-gray-700 rounded-lg py-2 px-4 pl-10 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-500"></i>
                        </div>
                    </div>

                    <div id="client-folders-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Client folders will be dynamically inserted here -->
                    </div>
                </section>

                <!-- Recent Uploads Section -->
                <section>
                    <h3 class="text-xl font-semibold text-primary mb-4">Recent Uploads</h3>
                    
                    <div class="bg-darker rounded-xl p-6 shadow-lg">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-primary uppercase bg-gray-800">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Photo</th>
                                        <th scope="col" class="px-6 py-3">Client</th>
                                        <th scope="col" class="px-6 py-3">Date</th>
                                        <th scope="col" class="px-6 py-3">Size</th>
                                        <th scope="col" class="px-6 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-uploads-tbody">
                                    <!-- Recent uploads will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Client View -->
    <div id="client-view" class="hidden flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-darker py-4 px-6 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-camera text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold text-primary">Onpoint Galleries</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="client-logout-btn" class="bg-primary hover:bg-opacity-90 text-dark font-medium py-2 px-4 rounded-lg transition">
                        Exit Gallery
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <div class="max-w-7xl mx-auto">
                <!-- Client Gallery Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                    <div>
                        <h2 id="client-gallery-title" class="text-2xl font-bold text-primary mb-2">Your Photo Gallery</h2>
                        <p class="text-gray-400">Photos shared with you by your photographer</p>
                    </div>
                    <button id="download-all-btn" class="bg-primary hover:bg-opacity-90 text-dark font-medium py-2 px-4 rounded-lg transition mt-4 md:mt-0">
                        <i class="fas fa-download mr-2"></i> Download All
                    </button>
                </div>

                <!-- Admin Upload Section (hidden by default) -->
                <section id="client-upload-section" class="mb-12 hidden">
                    <h3 class="text-xl font-semibold text-primary mb-4">Upload More Photos</h3>
                    <div class="bg-darker rounded-xl p-6 shadow-lg">
                        <div id="client-dropzone" class="dropzone rounded-lg p-8 text-center cursor-pointer">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-cloud-upload-alt text-primary text-5xl mb-4"></i>
                                <h4 class="text-lg font-medium mb-2">Drag & Drop files here</h4>
                                <p class="text-gray-500 mb-4">or</p>
                                <p class="text-white">Click to select files</p>
                            </div>
                        </div>
                        <input id="client-file-upload" type="file" class="hidden" multiple accept="image/jpeg, image/png, image/gif">

                        <div class="mt-6 flex justify-center">
                            <button id="client-upload-btn" class="w-full md:w-auto bg-primary hover:bg-opacity-90 text-dark font-medium py-2.5 px-6 rounded-lg transition">
                                <i class="fas fa-upload mr-2"></i> Upload to this Gallery
                            </button>
                        </div>
                        <p id="client-dropzone-feedback" class="text-sm text-center text-gray-400 mt-4"></p>
                    </div>
                </section>

                <!-- Folders Navigation -->
                <div class="mb-6 overflow-x-auto custom-scrollbar">
                    <div id="folder-tabs-container" class="flex space-x-2 pb-2">
                        <!-- Folder tabs will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Photo Grid -->
                <div id="photo-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- Photo thumbnails will be dynamically inserted here -->
                </div>

                <!-- Photo Viewer Modal -->
                <div id="photo-viewer-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
                    <div class="relative w-full h-full flex items-center justify-center">
                        <button id="close-viewer" class="absolute top-6 right-6 text-white hover:text-primary text-2xl z-10">
                            <i class="fas fa-times"></i>
                        </button>
                        <button id="prev-photo" class="absolute left-6 text-white hover:text-primary text-3xl z-10">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="next-photo" class="absolute right-6 text-white hover:text-primary text-3xl z-10">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div class="max-w-5xl max-h-[90vh] mx-auto p-4 flex flex-col items-center justify-center">
                            <img id="viewer-image" src="" alt="Full size photo" class="max-h-[80vh] max-w-full object-contain">
                            <div class="mt-4 text-center text-white">
                                <p id="photo-filename" class="font-medium"></p>
                                <div class="flex justify-center items-center space-x-4 mt-3">
                                    <button id="download-current" class="bg-primary hover:bg-opacity-90 text-dark font-medium py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-download mr-2"></i> Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Client Modal -->
    <div id="new-client-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-darker rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-primary">Add New Client</h3>
                <button id="close-client-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="new-client-form" class="space-y-4">
                <div>
                    <label for="client-name" class="block text-sm font-medium text-gray-400 mb-1">Client Name</label>
                    <input type="text" id="client-name" class="bg-gray-800 border border-gray-700 text-gray-200 rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" placeholder="Enter client name" required>
                </div>
                <div>
                    <label for="client-email" class="block text-sm font-medium text-gray-400 mb-1">Email (optional)</label>
                    <input type="email" id="client-email" class="bg-gray-800 border border-gray-700 text-gray-200 rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" placeholder="client@example.com">
                </div>
                <div>
                    <label for="client-phone" class="block text-sm font-medium text-gray-400 mb-1">Phone (optional)</label>
                    <input type="tel" id="client-phone" class="bg-gray-800 border border-gray-700 text-gray-200 rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" placeholder="+1 (123) 456-7890">
                </div>
                <div class="pt-2">
                    <button type="submit" class="w-full bg-primary hover:bg-opacity-90 text-dark font-medium py-2 px-4 rounded-lg transition">
                        Create Client Folder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-darker rounded-xl p-6 w-full max-w-md">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-500 bg-opacity-20 rounded-full flex items-center justify-center mb-4 mx-auto">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-white mb-2">Delete Client Folder</h3>
                <p id="delete-confirm-text" class="text-gray-400 mb-6">Are you sure? This will remove the client and all their photos permanently.</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-delete-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-6 rounded-lg transition">
                        Cancel
                    </button>
                    <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition">
                        Confirm Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Photo Confirmation Modal -->
    <div id="delete-photo-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-darker rounded-xl p-6 w-full max-w-md">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-500 bg-opacity-20 rounded-full flex items-center justify-center mb-4 mx-auto">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-white mb-2">Delete Photo</h3>
                <p id="delete-photo-confirm-text" class="text-gray-400 mb-6">Are you sure you want to delete this photo permanently?</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-delete-photo-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-6 rounded-lg transition">
                        Cancel
                    </button>
                    <button id="confirm-delete-photo-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition">
                        Confirm Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Link Modal -->
    <div id="share-link-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-darker rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-primary">Share Gallery Link</h3>
                <button id="close-share-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-400">Share this link with your client to give them access to their photos:</p>
                <div class="flex">
                    <input id="share-link-input" type="text" value="" class="flex-1 bg-gray-800 border border-gray-700 text-gray-200 rounded-l-lg p-2.5 focus:outline-none focus:ring-1 focus:ring-primary" readonly>
                    <button id="copy-link-btn" class="bg-primary hover:bg-opacity-90 text-dark font-medium py-2 px-4 rounded-r-lg transition">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script>
        const API_URL = 'http://localhost:3000';

        // --- DOM Elements ---
        const getEl = (id) => document.getElementById(id);
        const adminDashboard = getEl('admin-dashboard');
        const clientView = getEl('client-view');
        const newClientBtn = getEl('new-client-btn');
        const newClientModal = getEl('new-client-modal');
        const closeClientModal = getEl('close-client-modal');
        const newClientForm = getEl('new-client-form');
        const shareLinkModal = getEl('share-link-modal');
        const closeShareModal = getEl('close-share-modal');
        const photoViewerModal = getEl('photo-viewer-modal');
        const closeViewer = getEl('close-viewer');
        const clientLogoutBtn = getEl('client-logout-btn');
        const dropzone = getEl('dropzone');
        const fileUpload = getEl('file-upload');
        const uploadBtn = getEl('upload-btn');
        const copyLinkBtn = getEl('copy-link-btn');
        const shareLinkInput = getEl('share-link-input');
        const downloadAllBtn = getEl('download-all-btn');
        const deleteConfirmModal = getEl('delete-confirm-modal');
        const cancelDeleteBtn = getEl('cancel-delete-btn');
        const confirmDeleteBtn = getEl('confirm-delete-btn');
        const clientSearchInput = getEl('client-search-input');

        let folderToDelete = null;
        let photoToDelete = null;
        let filesToUpload = [];
        let db = { clients: [], photos: [] };

        // --- Toast Notifications ---
        function showToast(message, type = 'success') {
            const toastContainer = getEl('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon} toast-icon"></i><p>${message}</p>`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 3000);
            }, 3000);
        }

        // --- Data Persistence (Now through API) ---
        async function loadDb() {
            try {
                const response = await fetch(`${API_URL}/api/data`);
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                db = await response.json();
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Could not load gallery data.', 'error');
                db = { clients: [], photos: [] };
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderAdminDashboard() {
            const clientFoldersGrid = getEl('client-folders-grid');
            const searchTerm = clientSearchInput.value.toLowerCase();
            const filteredClients = db.clients.filter(client => client.name.toLowerCase().includes(searchTerm));

            clientFoldersGrid.innerHTML = '';

            if (filteredClients.length === 0 && searchTerm === '') {
                clientFoldersGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 px-6 bg-darker rounded-xl">
                        <i class="fas fa-folder-open text-primary text-5xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-white mb-2">No Client Folders Yet</h3>
                        <p class="text-gray-400">Click "New Client" to create your first gallery.</p>
                    </div>`;
            } else if (filteredClients.length === 0) {
                 clientFoldersGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 px-6 bg-darker rounded-xl">
                        <i class="fas fa-search text-primary text-5xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-white mb-2">No Clients Found</h3>
                        <p class="text-gray-400">Try a different search term.</p>
                    </div>`;
            } else {
                filteredClients.forEach(client => {
                    // Render folder grid
                    const photoCount = db.photos.filter(p => p.clientId === client.id).length;
                    const folderEl = document.createElement('div');
                    folderEl.className = 'folder bg-darker rounded-xl p-4 shadow-lg transition cursor-pointer hover:shadow-primary/20';
                    folderEl.setAttribute('data-client-id', client.id);
                    folderEl.innerHTML = `
                        <div class="flex flex-col items-center">
                            <div class="w-16 h-16 bg-primary bg-opacity-20 rounded-full flex items-center justify-center mb-3">
                                <i class="fas fa-folder text-primary text-3xl"></i>
                            </div>
                            <h4 class="font-medium text-center">${client.name}</h4>
                            <p class="text-xs text-gray-500 mt-1">${photoCount} photos</p>
                            <div class="mt-3 flex space-x-2">
                                <button class="share-btn bg-primary bg-opacity-20 hover:bg-opacity-30 text-primary text-xs p-1.5 rounded-full" title="Share"><i class="fas fa-share-alt"></i></button>
                                <button class="delete-btn bg-red-500 bg-opacity-20 hover:bg-opacity-30 text-red-500 text-xs p-1.5 rounded-full" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                    clientFoldersGrid.appendChild(folderEl);
                });
            }
            
            addAdminEventListeners();
        }

        function renderRecentUploads() {
            const tbody = getEl('recent-uploads-tbody');
            tbody.innerHTML = '';
            const recentPhotos = [...db.photos].sort((a, b) => new Date(b.uploaded) - new Date(a.uploaded)).slice(0, 5);

            if (recentPhotos.length === 0) {
                tbody.innerHTML = `
                    <tr class="border-b border-gray-700"><td colspan="5" class="text-center py-8 text-gray-400"><i class="fas fa-image text-3xl mb-2"></i><p>No recent uploads</p></td></tr>`;
            } else {
                recentPhotos.forEach(photo => {
                    const client = db.clients.find(c => c.id === photo.clientId);
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-800';
                    row.innerHTML = `
                        <td class="px-6 py-4"><div class="flex items-center"><div class="w-10 h-10 rounded bg-primary bg-opacity-20 flex items-center justify-center mr-3"><img src="${API_URL}${photo.url}" class="w-full h-full object-cover rounded"></div><span>${photo.name}</span></div></td>
                        <td class="px-6 py-4">${client ? client.name : 'Unassigned'}</td>
                        <td class="px-6 py-4">${new Date(photo.uploaded).toLocaleDateString()}</td>
                        <td class="px-6 py-4">${(photo.size / 1024 / 1024).toFixed(2)} MB</td>
                        <td class="px-6 py-4"><div class="flex space-x-2"><button class="text-primary hover:text-opacity-80" title="View"><i class="fas fa-eye"></i></button><button class="text-blue-400 hover:text-opacity-80" title="Download"><i class="fas fa-download"></i></button><button data-photo-id="${photo.id}" class="delete-recent-photo-btn text-red-500 hover:text-opacity-80" title="Delete"><i class="fas fa-trash"></i></button></div></td>`;
                    tbody.appendChild(row);
                });
            }
        }

        function renderClientView(clientId, isAdminView = false) {
            const client = db.clients.find(c => c.id === clientId);
            if (!client) {
                window.location.href = window.location.pathname;
                return;
            }

            getEl('client-gallery-title').textContent = `${client.name}'s Gallery`;
            const clientPhotos = db.photos.filter(p => p.clientId === clientId);
            const photoGrid = getEl('photo-grid');
            const folderTabsContainer = getEl('folder-tabs-container');
            photoGrid.innerHTML = '';
            folderTabsContainer.innerHTML = '';

            if (isAdminView) {
                getEl('client-upload-section').classList.remove('hidden');
                clientLogoutBtn.innerHTML = `<i class="fas fa-arrow-left mr-2"></i> Back to Dashboard`;
                setupClientUpload(clientId);
            }

            if (clientPhotos.length === 0) {
                 photoGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 px-6 bg-darker rounded-xl">
                        <i class="fas fa-camera-retro text-primary text-5xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-white mb-2">This Gallery is Empty</h3>
                        <p class="text-gray-400">The photographer hasn't uploaded any photos here yet.</p>
                    </div>`;
            } else {
                const folders = ['All Photos', 'Favorites'];
                folders.forEach((folder, index) => {
                    const isFavoriteTab = folder === 'Favorites';
                    const count = isFavoriteTab ? clientPhotos.filter(p => p.favorite).length : clientPhotos.length;
                    
                    if (isFavoriteTab && count === 0) return;

                    const tab = document.createElement('button');
                    tab.className = `folder-tab px-4 py-2 rounded-lg font-medium transition whitespace-nowrap`;
                    if (index === 0) tab.classList.add('bg-primary', 'text-dark');
                    else tab.classList.add('bg-darker', 'hover:bg-gray-800');
                    tab.innerHTML = `${folder} <span class="text-xs opacity-70 ml-1">${count}</span>`;
                    folderTabsContainer.appendChild(tab);
                });

                clientPhotos.forEach(photo => {
                    const photoEl = document.createElement('div');
                    photoEl.className = 'photo bg-darker rounded-lg overflow-hidden shadow-lg transition cursor-pointer relative group';
                    photoEl.setAttribute('data-photo-id', photo.id);
                    photoEl.innerHTML = `
                        <img src="${API_URL}${photo.url}" alt="${photo.name}" class="w-full h-48 object-cover">
                        ${isAdminView ? `
                        <div class="absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition z-10">
                            <button class="delete-photo-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-full" title="Delete Photo"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition z-10">
                            <button class="favorite-btn text-white bg-black bg-opacity-20 hover:text-red-500 p-2 rounded-full" title="Favorite"><i class="fas fa-heart ${photo.favorite ? 'text-red-500' : ''}"></i></button>
                        </div>
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <div class="flex space-x-3"><button class="download-btn bg-primary hover:bg-opacity-90 text-dark p-2 rounded-full" title="Download"><i class="fas fa-download"></i></button><button class="view-btn bg-white hover:bg-opacity-90 text-dark p-2 rounded-full" title="View Larger"><i class="fas fa-expand"></i></button></div>
                        </div>
                        <div class="p-3"><p class="text-sm truncate">${photo.name}</p><p class="text-xs text-gray-500">${(photo.size / 1024 / 1024).toFixed(2)} MB</p></div>`;
                    photoGrid.appendChild(photoEl);
                });
            }
            addClientEventListeners();
        }

        // --- EVENT HANDLER ATTACHMENT ---
        function addAdminEventListeners() {
            document.querySelectorAll('.share-btn').forEach(btn => btn.onclick = (e) => {
                e.stopPropagation();
                const clientId = e.currentTarget.closest('.folder').getAttribute('data-client-id');
                const shareUrl = new URL(window.location.origin + window.location.pathname);
                shareUrl.searchParams.set('token', `client_${clientId}`);
                shareLinkInput.value = shareUrl.href;
                shareLinkModal.classList.remove('hidden');
            });
            document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = (e) => {
                e.stopPropagation();
                folderToDelete = e.currentTarget.closest('.folder');
                const client = db.clients.find(c => c.id == folderToDelete.getAttribute('data-client-id'));
                getEl('delete-confirm-text').innerHTML = `Are you sure you want to delete the folder for <strong>${client.name}</strong>? <br>This will remove the client and all their photos permanently.`;
                deleteConfirmModal.classList.remove('hidden');
            });
            document.querySelectorAll('.folder').forEach(folder => folder.onclick = (e) => {
                if (e.target.closest('button')) return;
                window.location.href = `${window.location.pathname}?token=client_${folder.getAttribute('data-client-id')}&admin=true`;
            });
        }
        
        function addClientEventListeners() {
            document.querySelectorAll('.view-btn').forEach(btn => btn.onclick = e => {
                e.stopPropagation();
                openPhotoViewer(e.currentTarget.closest('.photo').getAttribute('data-photo-id'));
            });
            document.querySelectorAll('.download-btn').forEach(btn => btn.onclick = e => {
                e.stopPropagation();
                const photo = db.photos.find(p => p.id == e.currentTarget.closest('.photo').getAttribute('data-photo-id'));
                if (!photo) return;
                const link = document.createElement('a');
                link.href = `${API_URL}${photo.url}`;
                link.download = photo.name;
                link.click();
            });
            document.querySelectorAll('.favorite-btn').forEach(btn => btn.onclick = e => {
                e.stopPropagation();
                toggleFavorite(e.currentTarget.closest('.photo').getAttribute('data-photo-id'));
            });
            document.querySelectorAll('.folder-tab').forEach(tab => tab.onclick = (e) => {
                document.querySelectorAll('.folder-tab').forEach(t => t.classList.remove('bg-primary', 'text-dark') || t.classList.add('bg-darker', 'hover:bg-gray-800'));
                e.currentTarget.classList.add('bg-primary', 'text-dark');
                e.currentTarget.classList.remove('bg-darker', 'hover:bg-gray-800');
                const folderName = e.currentTarget.textContent.split(' ')[0].trim();
                filterPhotosByFolder(folderName);
            });
            document.querySelectorAll('.photo').forEach(el => el.onclick = e => {
                if (e.target.closest('button')) return;
                openPhotoViewer(el.getAttribute('data-photo-id'));
            });
            document.querySelectorAll('.delete-recent-photo-btn').forEach(btn => btn.onclick = (e) => {
                e.stopPropagation();
                handlePhotoDeleteClick(e.currentTarget.getAttribute('data-photo-id'));
            });
            document.querySelectorAll('.delete-photo-btn').forEach(btn => btn.onclick = e => {
                e.stopPropagation();
                handlePhotoDeleteClick(e.currentTarget.closest('.photo').getAttribute('data-photo-id'));
            });
        }

        // --- CORE LOGIC ---
        function handlePhotoDeleteClick(id) {
            photoToDelete = id;
            const photo = db.photos.find(p => p.id == photoToDelete);
            if (photo) {
                getEl('delete-photo-confirm-text').innerHTML = `Are you sure you want to delete <strong>${photo.name}</strong>? This action is permanent.`;
            }
            getEl('delete-photo-confirm-modal').classList.remove('hidden');
        }

        function filterPhotosByFolder(folderName) {
            document.querySelectorAll('.photo').forEach(photoEl => {
                const photo = db.photos.find(p => p.id == photoEl.getAttribute('data-photo-id'));
                let show = false;
                if (folderName === 'All' || !folderName) {
                    show = true;
                } else if (folderName === 'Favorites') {
                    show = photo.favorite;
                }
                photoEl.style.display = show ? 'block' : 'none';
            });
        }
        
        async function toggleFavorite(photoId) {
            const photo = db.photos.find(p => p.id == photoId);
            if (!photo) return;

            try {
                const response = await fetch(`${API_URL}/api/photos/${photoId}/favorite`, { method: 'PUT' });
                if (!response.ok) throw new Error('Failed to toggle favorite');
                
                const updatedPhoto = await response.json();
                photo.favorite = updatedPhoto.favorite;

                const urlParams = new URLSearchParams(window.location.search);
                const clientToken = urlParams.get('token');
                if (clientToken) {
                    const clientId = parseInt(clientToken.split('_')[1]);
                    const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
                    const activeTab = document.querySelector('.folder-tab.bg-primary');
                    renderClientView(clientId, isAdmin);
                    if(activeTab) {
                        // Re-select the previously active tab after re-render
                        document.querySelectorAll('.folder-tab').forEach(t => {
                            if (t.textContent.split(' ')[0].trim() === activeTab.textContent.split(' ')[0].trim()) {
                                t.click();
                            }
                        });
                    }
                }
            } catch(error) {
                console.error("Error toggling favorite:", error);
                showToast("Could not update favorite status.", "error");
            }
        }
        
        function openPhotoViewer(photoId) {
            const photo = db.photos.find(p => p.id == photoId);
            if (!photo) return;
            const visiblePhotos = getVisiblePhotos();
            const currentIndex = visiblePhotos.findIndex(p => p.id == photoId);
            getEl('viewer-image').src = `${API_URL}${photo.url}`;
            getEl('viewer-image').setAttribute('data-current-photo-id', photo.id);
            getEl('photo-filename').textContent = `${photo.name} (${currentIndex + 1} of ${visiblePhotos.length})`;
            
            const favBtnContainer = getEl('download-current').parentElement;
            let favBtn = favBtnContainer.querySelector('.favorite-btn');
            if (!favBtn) {
                favBtn = document.createElement('button');
                favBtn.className = 'favorite-btn text-white hover:text-red-500 p-2 rounded-full text-2xl';
                favBtnContainer.prepend(favBtn);
            }
            favBtn.innerHTML = `<i class="fas fa-heart ${photo.favorite ? 'text-red-500' : ''}"></i>`;
            favBtn.title = "Favorite";
            favBtn.onclick = (e) => { e.stopPropagation(); toggleFavorite(photo.id); openPhotoViewer(photo.id); }; // Re-opens viewer to refresh state
            
            photoViewerModal.classList.remove('hidden');
        }

        function getVisiblePhotos() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = parseInt(urlParams.get('token')?.split('_')[1]);
            const clientPhotos = db.photos.filter(p => p.clientId === clientId);
            const activeTab = document.querySelector('.folder-tab.bg-primary');
            const folderName = activeTab ? activeTab.textContent.split(' ')[0].trim() : 'All';

            if (folderName === 'Favorites') {
                return clientPhotos.filter(p => p.favorite);
            }
            return clientPhotos;
        }

        function handleFiles(selectedFiles) {
            if (selectedFiles.length === 0) return;
            filesToUpload = [...selectedFiles];
            const feedback = getEl('client-dropzone-feedback');
            if (feedback) {
                feedback.textContent = `${filesToUpload.length} file(s) selected. Ready to upload.`;
            }
        }
        
        async function executeClientUpload(clientId, uploadBtn) {
            if (filesToUpload.length === 0) { showToast('Please select files to upload first.', 'error'); return; }

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';

            const formData = new FormData();
            formData.append('clientId', clientId);
            filesToUpload.forEach(file => {
                formData.append('photos', file);
            });

            try {
                const response = await fetch(`${API_URL}/api/photos`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Upload failed');
                }

                const newPhotos = await response.json();
                db.photos.push(...newPhotos);
                
                showToast(`${newPhotos.length} photos uploaded successfully!`);
                filesToUpload = [];
                getEl('client-dropzone-feedback').textContent = '';
                
                const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
                renderClientView(clientId, isAdmin);

            } catch (error) {
                console.error("Error uploading files:", error);
                showToast(error.message || 'An error occurred during upload. Please try again.', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i> Upload to this Gallery';
            }
        }

        function setupClientUpload(clientId) {
            const dropzone = getEl('client-dropzone');
            const fileUpload = getEl('client-file-upload');
            const uploadBtn = getEl('client-upload-btn');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => dropzone.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }, false));
            ['dragenter', 'dragover'].forEach(eName => dropzone.addEventListener(eName, () => dropzone.classList.add('active'), false));
            ['dragleave', 'drop'].forEach(eName => dropzone.addEventListener(eName, () => dropzone.classList.remove('active'), false));
            dropzone.onclick = () => fileUpload.click();
            dropzone.ondrop = (e) => handleFiles(e.dataTransfer.files);
            fileUpload.onchange = (e) => handleFiles(e.target.files);
            uploadBtn.onclick = () => executeClientUpload(clientId, uploadBtn);
        }

        // --- INITIALIZATION & ROUTING ---
        async function init() {
            await loadDb();
            const urlParams = new URLSearchParams(window.location.search);
            const clientToken = urlParams.get('token');
            const isAdminView = urlParams.get('admin') === 'true';

            if (clientToken && clientToken.startsWith('client_')) {
                const clientId = parseInt(clientToken.split('_')[1]);
                adminDashboard.classList.add('hidden');
                clientView.classList.remove('hidden');
                renderClientView(clientId, isAdminView);
            } else {
                adminDashboard.classList.remove('hidden');
                clientView.classList.add('hidden');
                renderAdminDashboard();
                renderRecentUploads();
            }
            addGlobalEventListeners();
        }
        
        // --- GLOBAL EVENT LISTENERS ---
        function addGlobalEventListeners() {
            newClientBtn.onclick = () => newClientModal.classList.remove('hidden');
            closeClientModal.onclick = () => newClientModal.classList.add('hidden');
            newClientForm.onsubmit = async (e) => {
                e.preventDefault();
                const clientNameInput = getEl('client-name');
                const clientName = clientNameInput.value.trim();
                if (!clientName) {
                    showToast('Client name cannot be empty.', 'error');
                    return;
                }
                
                const newClientData = { 
                    name: clientName, 
                    email: getEl('client-email').value, 
                    phone: getEl('client-phone').value 
                };

                try {
                    const response = await fetch(`${API_URL}/api/clients`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newClientData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create client');
                    }

                    const createdClient = await response.json();
                    db.clients.push(createdClient);
                    showToast('New client created!');
                    renderAdminDashboard();
                    newClientModal.classList.add('hidden');
                    newClientForm.reset();
                } catch(error) {
                    console.error("Error creating client:", error);
                    showToast("Could not create client.", "error");
                }
            };

            closeShareModal.onclick = () => shareLinkModal.classList.add('hidden');
            closeViewer.onclick = () => photoViewerModal.classList.add('hidden');
            clientLogoutBtn.onclick = () => window.location.href = window.location.pathname;
            cancelDeleteBtn.onclick = () => deleteConfirmModal.classList.add('hidden');
            confirmDeleteBtn.onclick = async () => {
                if (folderToDelete) {
                    const clientId = parseInt(folderToDelete.getAttribute('data-client-id'));
                    try {
                        const response = await fetch(`${API_URL}/api/clients/${clientId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete client');

                        db.clients = db.clients.filter(c => c.id !== clientId);
                        db.photos = db.photos.filter(p => p.clientId !== clientId);
                        
                        showToast('Client folder deleted.');
                        renderAdminDashboard();
                        renderRecentUploads();
                    } catch (error) {
                        console.error("Error deleting client:", error);
                        showToast("Could not delete client.", "error");
                    }
                }
                deleteConfirmModal.classList.add('hidden');
            };

            getEl('cancel-delete-photo-btn').onclick = () => getEl('delete-photo-confirm-modal').classList.add('hidden');
            getEl('confirm-delete-photo-btn').onclick = async () => {
                if (photoToDelete) {
                    try {
                        const response = await fetch(`${API_URL}/api/photos/${photoToDelete}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete photo');
                        
                        db.photos = db.photos.filter(p => p.id != photoToDelete);
                        
                        const urlParams = new URLSearchParams(window.location.search);
                        const clientToken = urlParams.get('token');
                        const isAdminView = urlParams.get('admin') === 'true';

                        if (clientToken && clientToken.startsWith('client_')) {
                            const clientId = parseInt(clientToken.split('_')[1]);
                            renderClientView(clientId, isAdminView);
                        } else {
                            renderAdminDashboard();
                            renderRecentUploads();
                        }

                        showToast('Photo deleted successfully.');
                        photoToDelete = null;

                    } catch(error) {
                        console.error("Error deleting photo:", error);
                        showToast("Could not delete photo.", "error");
                    }
                }
                getEl('delete-photo-confirm-modal').classList.add('hidden');
            };

            copyLinkBtn.onclick = () => {
                shareLinkInput.select();
                document.execCommand('copy');
                showToast('Link copied to clipboard!');
            };

            downloadAllBtn.onclick = () => {
                showToast('Sorry, zipping and downloading all photos is not supported in this demo.', 'error');
            };

            clientSearchInput.onkeyup = renderAdminDashboard;
            
            // Photo viewer navigation
            getEl('prev-photo').onclick = () => {
                const currentId = parseInt(getEl('viewer-image').getAttribute('data-current-photo-id'));
                const visiblePhotos = getVisiblePhotos();
                const currentIndex = visiblePhotos.findIndex(p => p.id === currentId);
                if (currentIndex > 0) openPhotoViewer(visiblePhotos[currentIndex - 1].id);
            };
            getEl('next-photo').onclick = () => {
                const currentId = parseInt(getEl('viewer-image').getAttribute('data-current-photo-id'));
                const visiblePhotos = getVisiblePhotos();
                const currentIndex = visiblePhotos.findIndex(p => p.id === currentId);
                if (currentIndex < visiblePhotos.length - 1) openPhotoViewer(visiblePhotos[currentIndex + 1].id);
            };
            getEl('download-current').onclick = () => {
                 const photo = db.photos.find(p => p.id == getEl('viewer-image').getAttribute('data-current-photo-id'));
                 if(photo) {
                    const link = document.createElement('a');
                    link.href = `${API_URL}${photo.url}`;
                    link.download = photo.name;
                    link.click();
                 }
            };
        }

        // --- KICK IT OFF ---
        init();
    </script>
</body>
</html>